<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UWA G1 Dashboard</title>
  <link rel="icon" type="image/png" href="/static/favicon/favicon.ico">
  <script src="/static/js/misc/socket.js"></script>
  <script src="/static/js/misc/chart.js"></script>

    
    <!-- stuff for point clouds (misery)-->
  <script src="/static/js/pointcloud/jquery.js"></script>
  <script src="/static/js/pointcloud/gl-matrix.js"></script>
  <script src="/static/js/pointcloud/litegl.min.js"></script>
  <script src="/static/js/pointcloud/Viewer.js"></script>
  <script src="/static/js/pointcloud/Space3DViewer.js"></script>
  <script src="/static/js/pointcloud/PointCloud2Viewer.js"></script>
    <!-- end -->


    <!-- main display manager -->
  <script src="/static/js/ros_display_manager.js"></script>
  <script src="/static/js/subscription_manager.js"></script>
    <!-- end -->


    <!-- ros websocket stuff -->
  <script src="/static/js/roswebsocket/eventemitter2.min.js"></script>
  <script src="/static/js/roswebsocket/eventemitter3.min.js"></script>
  <script src="/static/js/roswebsocket/roslib.min.js"></script>
  <script src="/static/js/roswebsocket/createjs.min.js"></script>
  <script src="/static/js/misc/tailwind.js"></script>
  <script src="/static/js/roswebsocket/ros2d.min.js"></script>
  <script src="/static/js/roswebsocket/nav2d.min.js"></script>
  <script src="/static/js/roswebsocket/three.min.js"></script>
  <script src="/static/js/roswebsocket/ros3d.min.js"></script>
    <!-- end -->

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="/static/js/misc/alpine.js" defer></script>
</head>
<style>

  .setWhite {
    height: 100%;
    overflow: hidden;
  }

  .primary {
    background-color: #212121
  }

  .topic-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    height: 100%;
  }

  .topic-container > div {
    height: 95%; 
    align-self: center;
    justify-self: center;
    width: 95%;
  }
  .border-coloured {
    border: 1px solid #414141;
  }

  .secondary {
    background-color: #181818;
  }
</style>
<body class="secondary">
  <div class="flex h-screen text-white flex-col " x-data="{ openPanel: null }">
    <div class="flex flex-col h-full lg:flex-row max-h-[96vh] lg:max-h-[92vh]">
      <!-- Left button column -->
      <div class="order-2 lg:order-1 flex flex-row lg:flex-col min-h-16 lg:min-w-16 secondary border-coloured z-50">
        <button @click="openPanel = openPanel === 'run' ? null : 'run'" class="h-16 flex grow lg:grow-0 items-center justify-center hover:bg-gray-700">
          <i class="material-icons">play_arrow</i>
        </button>
        <button @click="openPanel = openPanel === 'layout' ? null : 'layout'" class="h-16 grow lg:grow-0 flex items-center justify-center hover:bg-gray-700">
          <i class="material-icons">view_quilt</i>
        </button>
        <div class="grow-0 lg:grow"></div>
        <button id="killButton" class="h-16 flex items-center justify-center grow lg:grow-0 hover:bg-gray-700 ">
          <i class="material-icons text-red-600">stop_circle</i>
        </button>
      </div>

      <!-- panel column -->
      <div 
        x-show="openPanel" 
        x-transition:enter="transition ease-in-out duration-300 transform"
        x-transition:enter-start="-translate-x-full"
        x-transition:enter-end="translate-x-0"
        x-transition:leave="transition ease-in-out duration-300 transform"
        x-transition:leave-start="translate-x-0"
        x-transition:leave-end="-translate-x-full"
        class="order-3 lg:order-2 w-full lg:w-80 secondary border-coloured flex flex-col h-[30vh] lg:h-full"
      >
        <!-- Run panel -->
        <div x-show="openPanel === 'run'" class="flex flex-col h-full"  
        x-transition:enter="transition ease-in-out duration-300 transform"
        x-transition:enter-start="-translate-x-full"
        x-transition:enter-end="translate-x-0"
        x-transition:leave="transition ease-in-out duration-300 transform"
        x-transition:leave-start="translate-x-0"
        x-transition:leave-end="-translate-x-full">
          <div class="flex flex-col p-4 border-b border-[#414141]"> 
            <h1 class="text-xl font-bold">UWA G1 Dashboard</h1> 
          </div> 
          <div class="flex flex-col p-4 border-b border-[#414141] pt-0"> 
            <div class="flex flex-row pt-4"> 
              <p class="grow">G1 Status: </p> 
              <span id="G1Status" class="w-4 h-4 rounded-full bg-red-500 inline-block m-auto"></span> 
              <p id="G1StatusMessage" class="pl-2">Not Running</p> 
            </div> 
          </div> 
          <div id="buttonContainer" class="flex flex-col gap-4 p-4 flex-1 overflow-auto"> 
          </div>
        </div>

        <!-- Layout panel -->
        <div x-show="openPanel === 'layout'" class="flex flex-col h-full"
        x-transition:enter="transition ease-in-out duration-300 transform"
        x-transition:enter-start="-translate-x-full"
        x-transition:enter-end="translate-x-0"
        x-transition:leave="transition ease-in-out duration-300 transform"
        x-transition:leave-start="translate-x-0"
        x-transition:leave-end="-translate-x-full">
          <div class="flex flex-col p-4 border-b border-[#414141]"> 
            <h1 class="text-xl font-bold">Layout</h1> 
          </div> 
          <div class="flex flex-col p-4 border-b border-[#414141] pt-0"> 
            <div class="flex flex-row pt-4"> 
              <p class="grow">Panel Count: </p> 
              <p id="panelCount" class="pl-2">0</p> 
            </div> 
          </div> 
          <div id="layoutContainer" class="flex flex-col gap-4 flex-1 overflow-auto"> 
          </div>
        </div>
      </div>

      <!-- Main content area -->
      <main class="order-1 lg:order-3 flex-1 p-4 secondary overflow-auto">
        <div id="main-container" class="flex flex-wrap gap-4 p-4 secondary rounded overflow-auto">
        </div>
      </main>
    </div>
    <footer class="order-4 lg:order-4 h-[4vh]  lg:h-[8vh] w-full secondary p-4 flex flex-row gap-4 items-center" style="border: 1px solid #414141">
      <div class="grow flex-row gap-4 flex">
        <p id="cpu"></p>
        <p id="memory"></p>
        <p id="disk"></p>
      </div>
      <div class="flex items-center gap-2">
        <span id="footerStatus" class="w-4 h-4 rounded-full bg-red-500 inline-block"></span>
        <p class="message" id="footerMessage">No action yet</p>
      </div>
    </footer>
  </div>


  <script type="module">
    const socket = io(`http://${window.location.hostname}:8000`);
    const ros = new ROSLIB.Ros({ url: `ws://${window.location.hostname}:9090` });
    const manager = new ROSDisplayManager("main-container", ros);
    const killButton = document.getElementById("killButton");
    socket.on("connect", async () => {
      await get("/state");
    });

    const G1Message = document.getElementById("G1StatusMessage");
    const G1Status = document.getElementById("G1Status");
    const FooterMessage = document.getElementById("footerMessage");
    const FooterStatus = document.getElementById("footerStatus");


    socket.on("state", (data) => {
      G1Message.textContent = data.name;
      FooterMessage.textContent = data.name;

      if (data.running) {
        if (data.sim){
          G1Message.textContent += " (sim)";
          FooterMessage.textContent += " (sim)";
        }

        FooterStatus.classList.remove("bg-red-500");
        FooterStatus.classList.add("bg-green-500");
        G1Status.classList.remove("bg-red-500");
        G1Status.classList.add("bg-green-500");
      } else {
        FooterStatus.classList.remove("bg-green-500");
        FooterStatus.classList.add("bg-red-500");
        G1Status.classList.remove("bg-green-500");
        G1Status.classList.add("bg-red-500");
      }


      manager.createDisplays(data.topics);
      handleLayout(data.topics);
    });

    async function post(endpoint) {
      try {
        const res = await fetch(endpoint, { method: "POST" });
        const data = await res.json();
        return data;
      } catch (err) {
        console.error(err);
        return null;
      }
    }
    async function get(endpoint) {
      try {
        const res = await fetch(endpoint, { method: "GET" });
        const data = await res.json();
        return data;
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    killButton.onclick = () => get("/stop");

    // SIDE BAR STUFF
    let buttons = await get("/buttons")
    let container = document.getElementById("buttonContainer")
    buttons.forEach(group => {
      let groupDiv = document.createElement("div")
      groupDiv.className = "primary border-coloured rounded-2xl shadow p-4 flex flex-wrap gap-2"

      let title = document.createElement("h2")
      title.textContent = group.name + ":";
      title.className = "font-semibold text-white grow my-auto"
      groupDiv.appendChild(title)

      let buttonRow = document.createElement("div")
      buttonRow.className = "flex flex-row justify-between align-self"

      group.buttons.forEach(btn => {
        let el = document.createElement("button")
        el.title = btn.name;
        el.className = "w-12 h-12 flex items-center justify-center rounded-full hover:bg-gray-700 transition-colors shadow";

        el.onclick = () => post(btn.action)

        let icon = document.createElement("i")
        icon.className = "material-icons text-2xl"
        icon.textContent = btn.icon

        el.appendChild(icon)
        buttonRow.appendChild(el)
      })

      groupDiv.appendChild(buttonRow)
      container.appendChild(groupDiv)
    })

  function handleLayout(topicgroups) {
    const layoutContainer = document.getElementById("layoutContainer");
    const panelCount = document.getElementById("panelCount");
    layoutContainer.innerHTML = "";
    let panelCountNum = 0;

    topicgroups.forEach(topicgroup => {
      panelCountNum++;
      const panel = document.createElement("div");
      panel.className = "bg-neutral-900 rounded-2xl shadow-md p-4 mb-6 flex flex-col gap-3";

      const title = document.createElement("h2");
      title.textContent = topicgroup.name;
      title.className = "text-lg font-semibold text-white border-b border-neutral-700 pb-2";
      panel.appendChild(title);

      topicgroup.topics.forEach(topic => {
        const row = document.createElement("div");
        row.className = "flex justify-between flex-wrap items-center bg-neutral-800 rounded-xl px-3 py-2";

        const nameEl = document.createElement("span");
        nameEl.textContent = topic.name;
        nameEl.className = "text-white";

        const typeEl = document.createElement("span");
        typeEl.textContent = topic.type;
        typeEl.className = "text-sm text-neutral-400 italic";

        row.appendChild(nameEl);
        row.appendChild(typeEl);
        panel.appendChild(row);
      });

      layoutContainer.appendChild(panel);
    });

    panelCount.textContent = panelCountNum;
  }

  async function updateSystemStats() {
    const res = await fetch("/system-stats")
    const stats = await res.json()

    const cpuElem = document.getElementById("cpu")
    const memElem = document.getElementById("memory")
    const diskElem = document.getElementById("disk")

    function setColor(elem, value) {
      let color
      if (value < 50) color = "white"
      else if (value < 80) color = "orange"
      else color = "red"
      elem.style.color = color
    }

    cpuElem.textContent = `CPU: ${stats.cpu}%`
    memElem.textContent = `RAM: ${stats.memory}%`
    diskElem.textContent = `Disk: ${stats.disk}%`

    setColor(cpuElem, stats.cpu)
    setColor(memElem, stats.memory)
    setColor(diskElem, stats.disk)
  }
  setInterval(updateSystemStats, 2000)
  updateSystemStats()
  </script>
</body>
</html>
